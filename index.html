<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #121a3d 0%, #2e1547 50%, #121a3d 100%);
            min-height: 100vh;
            padding: 20px;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #121a3d 0%, #2e1547 50%, #121a3d 100%); }
            50% { background: linear-gradient(135deg, #2e1547 0%, #121a3d 50%, #2e1547 100%); }
        }

        .container {
            max-width: 1750px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            color: #2d3748;
            font-size: 3rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #121a3d, #2e1547);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .header p {
            color: #718096;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .canvas-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            font-size: 0.9rem;
            color: #121a3d;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: rgba(247, 250, 252, 0.8);
            border-radius: 16px;
            padding: 6px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.5);
        }

        .tab-button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            background: transparent;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .tab-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .tab-button:hover:before {
            left: 100%;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #121a3d, #2e1547);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: linear-gradient(135deg, #121a3d, #2e1547);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
        }

        .stat-card:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .form-section {
            background: linear-gradient(135deg, rgba(248, 249, 255, 0.8), rgba(255, 255, 255, 0.9));
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid rgba(226, 232, 240, 0.3);
            backdrop-filter: blur(10px);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        input, select, textarea {
            padding: 14px 16px;
            border: 2px solid rgba(226, 232, 240, 0.6);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 6px;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:hover:before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #121a3d, #2e1547);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa500, #ff8c00);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .button-group {
    display: flex;
    gap: 8px;
}



        .btn-secondary {
            background-color: #718096;
            color: white;
            border: none;
            margin-left: 8px;
        }

        .btn-secondary:hover {
            background-color: #4a5568;
        }

        .calendar-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9ff;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: #e2e8f0;
            transform: scale(1.05);
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #121a3d, #2e1547);
            color: white;
        }

        .calendar-day.has-assignment {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .calendar-day.has-assignment:after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        .list-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .item-card {
            background: linear-gradient(135deg, rgba(248, 249, 255, 0.9), rgba(255, 255, 255, 0.95));
            border: 2px solid rgba(226, 232, 240, 0.4);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .item-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            border-color: #121a3d;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .item-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            font-size: 0.95rem;
            color: #4a5568;
        }

        .detail-label {
            font-weight: 700;
            color: #2d3748;
        }

        .grade-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .grade-a { background: #e6ffed; color: #38a169; }
        .grade-b { background: #e6ffe6; color: #48bb78; }
        .grade-c { background: #fffbeb; color: #d69e2e; }
        .grade-d { background: #fff5f5; color: #e53e3e; }
        .grade-f { background: #fed7d7; color: #c53030; }
        .grade-none { background: #f7fafc; color: #718096; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #121a3d, #2e1547);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .priority-high { border-left: 6px solid #ff6b6b; }
        .priority-medium { border-left: 6px solid #ffa500; }
        .priority-low { border-left: 6px solid #48bb78; }

        .status-completed { 
            opacity: 0.8; 
            background: linear-gradient(135deg, rgba(230, 255, 237, 0.9), rgba(200, 255, 220, 0.8)) !important;
        }

        .due-soon {
            background: linear-gradient(135deg, rgba(255, 245, 245, 0.95), rgba(254, 215, 215, 0.9)) !important;
            border-color: #ff6b6b !important;
        }

        .search-box {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid rgba(226, 232, 240, 0.6);
            border-radius: 16px;
            font-size: 1.1rem;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .search-box:focus {
            border-color: #121a3d;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        .reminder-section {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.8), rgba(255, 245, 200, 0.9));
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-top: 15px;
        }

        .notification-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #121a3d;
        }

        .toggle-switch:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active:before {
            transform: translateX(25px);
        }

        .canvas-integration {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            font-size: 1.6rem;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px 20px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .item-details {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 480px) {
    .container {
        padding: 15px 10px;
        margin: 10px;
        border-radius: 15px;
    }
    
    .header h1 {
        font-size: 1.8rem;
        line-height: 1.2;
    }
    
    .header p {
        font-size: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .stat-card {
        padding: 20px 15px;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .form-section {
        padding: 20px 15px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .tabs {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .tab-button {
        flex: 1 1 calc(50% - 5px);
        min-width: 120px;
        padding: 12px 8px;
        font-size: 0.9rem;
    }
    
    .item-card {
        padding: 15px;
    }
    
    .item-name {
        font-size: 1.2rem;
    }
    
    .item-details {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .item-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .calendar-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .calendar-nav {
        justify-content: center;
    }
    
    .calendar-grid {
        gap: 1px;
    }
    
    .calendar-day {
        font-size: 0.9rem;
        min-height: 35px;
    }
    
    .search-box {
        padding: 15px;
        font-size: 1rem;
    }
    
    .btn {
        width: 100%;
        margin: 5px 0;
    }
    
    .calendar-nav .btn {
        width: auto;
        margin: 0 2px;
    }
    
    .canvas-integration {
        padding: 15px;
    }
    
    .reminder-section {
        padding: 15px;
    }
    
    .notification-toggle {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .list-container {
        padding: 15px;
    }
    
    .empty-state {
        padding: 30px 15px;
    }
    
    .empty-state h3 {
        font-size: 1.3rem;
    }
}

/* Additional improvements for very small screens */
@media (max-width: 320px) {
    .header h1 {
        font-size: 1.5rem;
    }
    
    .tab-button {
        flex: 1 1 100%;
        margin-bottom: 5px;
    }
    
    .stats-grid {
        gap: 10px;
    }
    
    .stat-card {
        padding: 15px 10px;
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .calendar-day {
        min-height: 30px;
        font-size: 0.8rem;
    }
    
    .btn-small {
        padding: 6px 10px;
        font-size: 0.8rem;
    }
}
.schedule-selector {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    background: #f8fafc;
    margin: 10px 0;
}

.schedule-header {
    font-weight: 600;
    margin-bottom: 12px;
    color: #2d3748;
}

.days-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 8px;
    margin-bottom: 16px;
}

.day-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.day-checkbox:hover {
    border-color: #3182ce;
    background: #ebf8ff;
}

.day-checkbox.selected {
    border-color: #3182ce;
    background: #3182ce;
    color: white;
}

.day-checkbox input[type="checkbox"] {
    display: none;
}

.time-selection {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    align-items: end;
}

.time-input-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.time-input-group label {
    font-size: 14px;
    font-weight: 500;
    color: #4a5568;
}

.time-input {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.time-input:focus {
    outline: none;
    border-color: #3182ce;
    box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
}

.schedule-display {
    margin-top: 12px;
    padding: 8px 12px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    font-size: 14px;
    color: #4a5568;
    min-height: 20px;
}

.schedule-display.has-schedule {
    color: #2d3748;
    font-weight: 500;
}

.tyler-albums-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.tyler-album-card {
    padding: 25px;
    border-radius: 16px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
}

.tyler-album-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.tyler-album-card:before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: shimmer 4s linear infinite;
    pointer-events: none;
}

.album-title {
    font-size: 1.3rem;
    font-weight: 800;
    margin-bottom: 10px;
    position: relative;
    z-index: 1;
}

.album-description {
    font-size: 0.95rem;
    margin-bottom: 12px;
    opacity: 0.9;
    line-height: 1.4;
    position: relative;
    z-index: 1;
}

.album-mood {
    font-size: 0.85rem;
    font-weight: 600;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    z-index: 1;
}

.philosophy-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.philosophy-card {
    background: linear-gradient(135deg, rgba(248, 249, 255, 0.9), rgba(255, 255, 255, 0.95));
    border: 2px solid rgba(226, 232, 240, 0.4);
    border-radius: 16px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.philosophy-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    border-color: #121a3d;
}

.philosophy-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
}

.philosophy-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 12px;
}

.philosophy-text {
    font-size: 0.95rem;
    color: #4a5568;
    line-height: 1.5;
}

.playlist-selector {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1));
    border: 2px solid rgba(255, 193, 7, 0.3);
    border-radius: 16px;
    padding: 20px;
}

#playlistSuggestions {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid rgba(226, 232, 240, 0.5);
}

.playlist-suggestion {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #667eea;
}

.playlist-title {
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 8px;
}

.playlist-description {
    color: #4a5568;
    font-size: 0.95rem;
    line-height: 1.4;
}

@media (max-width: 768px) {
    .tyler-albums-grid {
        grid-template-columns: 1fr;
    }
    
    .philosophy-cards {
        grid-template-columns: 1fr;
    }
    
    .tyler-album-card {
        padding: 20px;
    }
    
    .album-title {
        font-size: 1.1rem;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Testing yo gurt</h1>
            <p>gurt: yo</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab-button" onclick="showTab('assignments')">üìù Assignments</button>
            <button class="tab-button" onclick="showTab('classes')">üéì Classes</button>
            <button class="tab-button" onclick="showTab('calendar')">üìÖ Calendar</button>
            <button class="tab-button" onclick="showTab('grades')">üìà Grades</button>
            <button class="tab-button" onclick="showTab('canvas')">üîó Canvas</button>
            <button class="tab-button" onclick="showTab('tyler')">üêù Tyler</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalAssignments">0</div>
                    <div class="stat-label">Total Assignments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingAssignments">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedAssignments">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgGrade">-</div>
                    <div class="stat-label">Avg Grade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClasses">0</div>
                    <div class="stat-label">Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="dueSoon">0</div>
                    <div class="stat-label">Due This Week</div>
                </div>
            </div>

            <div class="list-container">
                <h3 style="margin-bottom: 25px; color: #2d3748; font-size: 1.5rem;">üî• Upcoming Assignments</h3>
                <div id="upcomingAssignments"></div>
            </div>
        </div>

        <!-- Assignments Tab -->
        <div id="assignments" class="tab-content">
            <div class="form-section">
                <h3 style="margin-bottom: 25px; color: #2d3748; font-size: 1.4rem;">Add New Assignment</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="assignmentName">Assignment Name *</label>
                        <input type="text" id="assignmentName" placeholder="e.g., Math Homework Ch. 5">
                    </div>
                    <div class="form-group">
                        <label for="assignmentClass">Class</label>
                        <select id="assignmentClass">
                            <option value="">Select a class...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="assignmentDue">Due Date *</label>
                        <input type="datetime-local" id="assignmentDue">
                    </div>
                    <div class="form-group">
                        <label for="assignmentPriority">Priority</label>
                        <select id="assignmentPriority">
                            <option value="low">üü¢ Low</option>
                            <option value="medium" selected>üü° Medium</option>
                            <option value="high">üî¥ High</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="assignmentPoints">Total Points</label>
                        <input type="number" id="assignmentPoints" placeholder="100" min="0">
                    </div>
                    <div class="form-group">
                        <label for="assignmentType">Assignment Type</label>
                        <select id="assignmentType">
                            <option value="homework">Homework</option>
                            <option value="quiz">Quiz</option>
                            <option value="exam">Exam</option>
                            <option value="project">Project</option>
                            <option value="essay">Essay</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="assignmentDescription">Description</label>
                        <textarea id="assignmentDescription" rows="3" placeholder="Assignment details, requirements, notes..."></textarea>
                    </div>
                </div>
                <div class="reminder-section">
                    <div class="notification-toggle">
                        <div class="toggle-switch" id="reminderToggle" onclick="toggleReminders()"></div>
                        <label>Enable Due Date Reminders</label>
                    </div>
                    <div class="form-row" id="reminderOptions" style="display: none;">
                        <div class="form-group">
                            <label for="reminderDays">Remind me</label>
                            <select id="reminderDays">
                                <option value="1">1 day before</option>
                                <option value="2">2 days before</option>
                                <option value="3" selected>3 days before</option>
                                <option value="7">1 week before</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addAssignment()">‚ú® Add Assignment</button>
            </div>

            <div class="list-container">
                <input type="text" class="search-box" id="assignmentSearch" placeholder="üîç Search assignments by name, class, or description..." onkeyup="filterAssignments()">
                <div id="assignmentsList"></div>
            </div>
        </div>

        <!-- Classes Tab -->
        <div id="classes" class="tab-content">
            <div class="form-section">
                <h3 style="margin-bottom: 25px; color: #2d3748; font-size: 1.4rem;">Add New Class</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="className">Class Name *</label>
                        <input type="text" id="className" placeholder="e.g., Advanced Mathematics">
                    </div>
                    <div class="form-group">
                        <label for="classCode">Class Code</label>
                        <input type="text" id="classCode" placeholder="e.g., MATH 201">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="classInstructor">Instructor</label>
                        <input type="text" id="classInstructor" placeholder="e.g., Prof. Smith">
                    </div>
                    <div class="form-group">
                        <label for="classSchedule">Schedule</label>
                        <div class="schedule-selector">
    <div class="schedule-header">Select Days</div>
    <div class="days-selection">
        <label class="day-checkbox" data-day="monday">
            <input type="checkbox" value="monday">
            <span>Mon</span>
        </label>
        <label class="day-checkbox" data-day="tuesday">
            <input type="checkbox" value="tuesday">
            <span>Tue</span>
        </label>
        <label class="day-checkbox" data-day="wednesday">
            <input type="checkbox" value="wednesday">
            <span>Wed</span>
        </label>
        <label class="day-checkbox" data-day="thursday">
            <input type="checkbox" value="thursday">
            <span>Thu</span>
        </label>
        <label class="day-checkbox" data-day="friday">
            <input type="checkbox" value="friday">
            <span>Fri</span>
        </label>
        <label class="day-checkbox" data-day="saturday">
            <input type="checkbox" value="saturday">
            <span>Sat</span>
        </label>
        <label class="day-checkbox" data-day="sunday">
            <input type="checkbox" value="sunday">
            <span>Sun</span>
        </label>
    </div>

    <div class="time-selection">
        <div class="time-input-group">
            <label for="startTime">Start Time</label>
            <input type="time" id="startTime" class="time-input">
        </div>
        <div class="time-input-group">
            <label for="endTime">End Time</label>
            <input type="time" id="endTime" class="time-input">
        </div>
    </div>

    <div class="schedule-display" id="scheduleDisplay">
        Select days and times to see schedule preview
    </div>
</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="classCredits">Credits</label>
                        <input type="number" id="classCredits" placeholder="3" min="1" max="6">
                    </div>
                    <div class="form-group">
                        <label for="classSemester">Semester</label>
                        <input type="text" id="classSemester" placeholder="e.g., Fall 2025">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addClass()">‚ûï Add Class</button>
            </div>

            <div class="list-container">
                <div id="classesList"></div>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3 id="currentMonth" style="color: #2d3748; font-size: 1.5rem;"></h3>
                    <div class="calendar-nav">
                        <button class="btn btn-small btn-primary" onclick="changeMonth(-1)">‚Äπ Prev</button>
                        <button class="btn btn-small btn-primary" onclick="goToToday()">Today</button>
                        <button class="btn btn-small btn-primary" onclick="changeMonth(1)">Next ‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-legend" style="display: flex; gap: 20px; justify-content: center; font-size: 0.9rem;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 4px;"></div>
                        <span>Today</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #ff6b6b, #ee5a52); border-radius: 4px;"></div>
                        <span>Has Assignment</span>
                    </div>
                </div>
            </div>
            <div class="list-container">
                <h3 style="margin-bottom: 20px; color: #2d3748;">üìÖ Selected Date: <span id="selectedDate">Today</span></h3>
                <div id="calendarAssignments"></div>
            </div>
        </div>

        <!-- Grades Tab -->
        <div id="grades" class="tab-content">
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-number" id="gpaDisplay">-</div>
                    <div class="stat-label">Current GPA</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="gradedAssignments">0</div>
                    <div class="stat-label">Graded</div>
                </div>
                <div class="stat-card">
                       <div class="stat-number" id="completionRate">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            </div>
            
            <div class="list-container">
                <h3 style="margin-bottom: 25px; color: #2d3748; font-size: 1.5rem;">üìä Grade Breakdown by Class</h3>
                <div id="gradesByClass"></div>
            </div>
        </div>

        <!-- Canvas Tab -->
        <div id="canvas" class="tab-content">
            <div class="canvas-integration">
                <h3 style="margin-bottom: 20px; color: #2d3748;">üîó Canvas LMS Integration</h3>
                <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                <strong>Note:</strong> Direct Canvas API connection may be limited by browser security policies. If connection fails, use the manual import option that will appear.
             </div>
                <p style="margin-bottom: 20px; color: #718096;">Connect your Canvas account to automatically sync courses and assignments.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="canvasUrl">Canvas Instance URL</label>
                        <input type="url" id="canvasUrl" placeholder="https://your-school.instructure.com">
                    </div>
                    <div class="form-group">
                        <label for="canvasToken">Access Token</label>
                        <input type="password" id="canvasToken" placeholder="Your Canvas API token">
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="connectCanvas()">üîó Connect to Canvas</button>
                   <button class="btn btn-success" onclick="syncCanvasWithRetry()" id="syncBtn" disabled>üîÑ Sync Data</button>
                   <button class="btn btn-danger" onclick="disconnectCanvas()" id="disconnectBtn" disabled>üîå Disconnect</button>
                </div>
                
                <div id="canvasStatus" style="padding: 15px; background: rgba(255,255,255,0.5); border-radius: 8px; margin-top: 15px;">
                    <strong>Status:</strong> <span id="connectionStatus">Not connected</span>
                </div>
            </div>
            
            <div class="list-container">
                <h3 style="margin-bottom: 20px; color: #2d3748;">üìã Canvas Sync Log</h3>
                <div id="syncLog"></div>
            </div>
        </div>
        <div id="tyler" class="tab-content">
    <div class="form-section">
        <h3 style="margin-bottom: 25px; color: #2d3748; font-size: 1.4rem;">üé® Tyler, The Creator Inspiration Hub</h3>
        <p style="color: #718096; margin-bottom: 20px;">Channel your creative energy with inspiration from Tyler Okonma's artistic journey.</p>
        
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #ff6b9d, #c44569);">
                <div class="stat-number">8</div>
                <div class="stat-label">Studio Albums</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ffa726, #fb8c00);">
                <div class="stat-number">OFWGKTA</div>
                <div class="stat-label">Odd Future Wolf Gang Kill Them All</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #66bb6a, #43a047);">
                <div class="stat-number">Golf Wang</div>
                <div class="stat-label">Clothing Brand</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #42a5f5, #1e88e5);">
                <div class="stat-number">Golf Le Fleur</div>
                <div class="stat-label">Fashion Brand</div>
            </div>
        </div>
    </div>

    <div class="list-container">
        <h3 style="margin-bottom: 25px; color: #2d3748; font-size: 1.5rem;">üéº Album Evolution</h3>
        <div class="tyler-albums-grid">
            <div class="tyler-album-card" style="background: linear-gradient(135deg, #350000, #5a0e0e); color: white;">
                <div class="album-title">Bastard (2009)</div>
                <div class="album-description">Raw, unfiltered debut mixtape that introduced Tyler's unique sound</div>
                <div class="album-mood">Dark & Experimental</div>
            </div>
            
            <div class="tyler-album-card" style="background: linear-gradient(135deg, #007b8b, #44afb3); color: white;">
                <div class="album-title">Goblin (2011)</div>
                <div class="album-description">First studio album exploring themes of fame and internal struggles</div>
                <div class="album-mood">Intense & Provocative</div>
            </div>
            
            <div class="tyler-album-card" style="background: linear-gradient(135deg, #93e6c6, #69f5ff); color: rgb(39, 39, 39);">
                <div class="album-title">Wolf (2013)</div>
                <div class="album-description">More mature sound with improved production and storytelling</div>
                <div class="album-mood">Narrative & Growth</div>
            </div>
            
            <div class="tyler-album-card" style="background: linear-gradient(135deg, #e14141, #ff0000); color: white;">
                <div class="album-title">Cherry Bomb (2015)</div>
                <div class="album-description">Experimental jazz-influenced album pushing creative boundaries</div>
                <div class="album-mood">Bold & Jazzy</div>
            </div>
            
            <div class="tyler-album-card" style="background: linear-gradient(135deg, #ffd700, #ffeb3b); color: #333;">
                <div class="album-title">Flower Boy (2017)</div>
                <div class="album-description">Vulnerable, introspective album about love and self-discovery</div>
                <div class="album-mood">Colorful & Honest</div>
            </div>
            
            <div class="tyler-album-card" style="background: linear-gradient(135deg, #f7b4c6, #b67c8c); color: #333;">
                <div class="album-title">IGOR (2019)</div>
                <div class="album-description">Grammy-winning concept album about heartbreak and obsession</div>
                <div class="album-mood">Emotional & Theatrical</div>
            </div>
            
            <div class="tyler-album-card" style="background: linear-gradient(135deg, #b9fff0, #32cd32); color: #333;">
                <div class="album-title">Call Me If You Get Lost (2021)</div>
                <div class="album-description">Travel-themed album showcasing lyrical prowess and confidence</div>
                <div class="album-mood">Adventurous & Mature</div>
            </div>

            <div class="tyler-album-card" style="background: linear-gradient(135deg, #95dce6, #4e2e13); color: white;">
                <ereerasd="https://open.spotify.com/album/0U28P0QVB1QRxpqp5IHOlH?si=cb4a71db37df488c" target="_blank">
                    <div class="album-title">Call Me If You Get Lost: The Estate Sale (2023)</div>
                    <div class="album-description">The extension of CMIYGL that dives deeper into the travel themes</div>
                    <div class="album-mood">Adventurous & Mature</div>
                </a>
            </div>
            <div class="tyler-album-card" style="background: linear-gradient(135deg, #343b35, #00853C); color: white;">
                <ereerasd="https://open.spotify.com/album/0U28P0QVB1QRxpqp5IHOlH?si=cb4a71db37df488c" target="_blank">
                    <div class="album-title">CHROMAKOPIA (2024)</div>
                    <div class="album-description">Introspective album exploring identity, masks, and vulnerability through experimental production</div>
                    <div class="album-mood">Complex & Transformative</div>
                </a>
            </div>
        </div>
    </div>

    <div class="list-container" style="margin-top: 30px;">
        <h3 style="margin-bottom: 25px; color: #2d3748; font-size: 1.5rem;">üé≠ Creative Philosophy</h3>
        <div class="philosophy-cards">
            <div class="philosophy-card">
                <div class="philosophy-icon">üé®</div>
                <div class="philosophy-title">Authentic Expression</div>
                <div class="philosophy-text">Tyler emphasizes being true to yourself and not conforming to others' expectations</div>
            </div>
            
            <div class="philosophy-card">
                <div class="philosophy-icon">üåà</div>
                <div class="philosophy-title">Colorful Creativity</div>
                <div class="philosophy-text">Embrace bold colors, unique aesthetics, and visual storytelling in all endeavors</div>
            </div>
            
            <div class="philosophy-card">
                <div class="philosophy-icon">üé™</div>
                <div class="philosophy-title">Theatrical Vision</div>
                <div class="philosophy-text">Create immersive experiences that transport audiences to different worlds</div>
            </div>
            
            <div class="philosophy-card">
                <div class="philosophy-icon">üèÜ</div>
                <div class="philosophy-title">Constant Evolution</div>
                <div class="philosophy-text">Never stay in one place creatively - always push boundaries and grow</div>
            </div>
        </div>
    </div>

    <div class="form-section" style="margin-top: 30px;">
        <h3 style="margin-bottom: 25px; color: #2d3748; font-size: 1.4rem;">üéµ Study Playlist Generator</h3>
        <p style="color: #718096; margin-bottom: 20px;">Create study playlists inspired by Tyler's different creative phases</p>
        
        <div class="playlist-selector">
            <div class="form-row">
                <div class="form-group">
                    <label for="studyMood">Study Mood</label>
                    <select id="studyMood" onchange="generatePlaylistSuggestions()">
                        <option value="">Select a mood...</option>
                        <option value="focus">Deep Focus</option>
                        <option value="creative">Creative Flow</option>
                        <option value="chill">Chill Vibes</option>
                        <option value="energy">High Energy</option>
                        <option value="introspective">Introspective</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="studySubject">Subject Area</label>
                    <select id="studySubject">
                        <option value="math">Mathematics</option>
                        <option value="english">English/Literature</option>
                        <option value="science">Science</option>
                        <option value="history">History</option>
                        <option value="art">Art/Creative</option>
                        <option value="general">General Study</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" onclick="generatePlaylistSuggestions()">üéµ Generate Playlist Ideas</button>
        </div>
        
        <div id="playlistSuggestions" style="margin-top: 20px;"></div>
    </div>
</div>
    </div>

<script>
// Data Storage
let classes = JSON.parse(localStorage.getItem('classes')) || [];
let assignments = JSON.parse(localStorage.getItem('assignments')) || [];
let currentDate = new Date();
let selectedCalendarDate = new Date();
let remindersEnabled = false;
let selectedDays = [];
let scheduleData = {
    days: [],
    startTime: '',
    endTime: ''
};
//Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(registration => {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, err => {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    updateDashboard();
    renderCalendar();
    requestNotificationPermission();
    checkReminders();
    setInterval(checkReminders, 60000); // Check every minute
    setTimeout(initializeScheduleSelector, 100);
});

// Tab Management
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'calendar') renderCalendar();
    if (tabName === 'assignments') renderAssignments();
    if (tabName === 'classes') renderClasses();
    if (tabName === 'grades') renderGrades();
}

// Class Management
function addClass() {
    const name = document.getElementById('className').value.trim();
    const code = document.getElementById('classCode').value.trim();
    const instructor = document.getElementById('classInstructor').value.trim();
    const credits = parseInt(document.getElementById('classCredits').value) || 3;
    const semester = document.getElementById('classSemester').value.trim();
    const schedule = getScheduleData();

    if (!name) {
        alert('Class name is required!');
        return;
    }

    const newClass = {
        id: Date.now(),
        name,
        code,
        instructor,
        schedule: schedule.formatted,
        scheduleData: schedule,
        credits,
        semester,
        createdAt: new Date().toISOString()
    };

    classes.push(newClass);
    saveData();
    updateClassDropdown();
    renderClasses();
    updateDashboard();
    clearClassForm();
}

function clearClassForm() {
    ['className', 'classCode', 'classInstructor', 'classCredits', 'classSemester']
        .forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
    clearScheduleForm();
}

function renderClasses() {
    const container = document.getElementById('classesList');
    if (classes.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No Classes Yet</h3><p>Add your first class to get started!</p></div>';
        return;
    }

    container.innerHTML = classes.map(cls => `
        <div class="item-card">
            <div class="item-header">
                <div>
                    <div class="item-name">${cls.name}</div>
                    <div style="color: #718096; font-size: 0.9rem;">${cls.code || 'No code'}</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary btn-small" onclick="editClass(${cls.id})">Edit</button>
                    <button class="btn btn-danger btn-small" onclick="deleteClass(${cls.id})">Delete</button>
                </div>
            </div>
            <div class="item-details">
                <div class="detail-item">
                    <span class="detail-label">Instructor:</span> ${cls.instructor || 'Not specified'}
                </div>
                <div class="detail-item">
                    <span class="detail-label">Schedule:</span> ${cls.schedule || 'Not specified'}
                </div>
                <div class="detail-item">
                    <span class="detail-label">Credits:</span> ${cls.credits}
                </div>
                <div class="detail-item">
                    <span class="detail-label">Semester:</span> ${cls.semester || 'Not specified'}
                </div>
            </div>
        </div>
    `).join('');
}

function deleteClass(id) {
    if (confirm('Delete this class? This will also remove all associated assignments.')) {
        classes = classes.filter(c => c.id !== id);
        assignments = assignments.filter(a => a.classId !== id);
        saveData();
        renderClasses();
        renderAssignments();
        updateDashboard();
        updateClassDropdown();
    }
}

// Schedule functionality
function initializeScheduleSelector() {
    // Day selection handlers
    document.querySelectorAll('.day-checkbox').forEach(dayLabel => {
        dayLabel.addEventListener('click', function(e) {
            e.preventDefault();
            const checkbox = this.querySelector('input[type="checkbox"]');
            const day = checkbox.value;
            
            if (selectedDays.includes(day)) {
                selectedDays = selectedDays.filter(d => d !== day);
                this.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedDays.push(day);
                this.classList.add('selected');
                checkbox.checked = true;
            }
            
            updateScheduleDisplay();
        });
    });

    // Time input handlers
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    
    if (startTimeInput) {
        startTimeInput.addEventListener('change', function() {
            scheduleData.startTime = this.value;
            updateScheduleDisplay();
        });
    }

    if (endTimeInput) {
        endTimeInput.addEventListener('change', function() {
            scheduleData.endTime = this.value;
            updateScheduleDisplay();
        });
    }
}

function updateScheduleDisplay() {
    const display = document.getElementById('scheduleDisplay');
    if (!display) return;
    
    if (selectedDays.length === 0) {
        display.textContent = 'Select days and times to see schedule preview';
        display.classList.remove('has-schedule');
        return;
    }

    let scheduleText = '';
    
    // Format days
    const dayNames = {
        monday: 'Monday',
        tuesday: 'Tuesday', 
        wednesday: 'Wednesday',
        thursday: 'Thursday',
        friday: 'Friday',
        saturday: 'Saturday',
        sunday: 'Sunday'
    };
    
    const dayAbbr = {
        monday: 'M',
        tuesday: 'T',
        wednesday: 'W',
        thursday: 'R',
        friday: 'F',
        saturday: 'S',
        sunday: 'U'
    };

    // Sort days by week order
    const weekOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const sortedDays = selectedDays.sort((a, b) => weekOrder.indexOf(a) - weekOrder.indexOf(b));
    
    if (sortedDays.length <= 3) {
        scheduleText = sortedDays.map(day => dayAbbr[day]).join('');
    } else {
        scheduleText = sortedDays.map(day => dayNames[day]).join(', ');
    }

    // Add time if both start and end are selected
    const startTime = document.getElementById('startTime')?.value || '';
    const endTime = document.getElementById('endTime')?.value || '';
    
    if (startTime && endTime) {
        const startFormatted = formatTime(startTime);
        const endFormatted = formatTime(endTime);
        scheduleText += ` ${startFormatted} - ${endFormatted}`;
    } else if (startTime) {
        scheduleText += ` ${formatTime(startTime)}`;
    }

    display.textContent = scheduleText;
    display.classList.add('has-schedule');
    
    // Update schedule data
    scheduleData.days = sortedDays;
    scheduleData.startTime = startTime;
    scheduleData.endTime = endTime;
}

function formatTime(time24) {
    if (!time24) return '';
    
    const [hours, minutes] = time24.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const hour12 = hour % 12 || 12;
    
    return `${hour12}:${minutes} ${ampm}`;
}

function getScheduleString() {
    const display = document.getElementById('scheduleDisplay');
    return display && display.classList.contains('has-schedule') ? display.textContent : '';
}

function getScheduleData() {
    return {
        ...scheduleData,
        formatted: getScheduleString()
    };
}

function setScheduleFromData(scheduleDataObj) {
    // Clear current selection
    selectedDays = [];
    document.querySelectorAll('.day-checkbox').forEach(label => {
        label.classList.remove('selected');
        const checkbox = label.querySelector('input');
        if (checkbox) checkbox.checked = false;
    });
    
    if (scheduleDataObj && scheduleDataObj.days) {
        // Use structured data if available
        selectedDays = [...scheduleDataObj.days];
        selectedDays.forEach(day => {
            const label = document.querySelector(`[data-day="${day}"]`);
            if (label) {
                label.classList.add('selected');
                const checkbox = label.querySelector('input');
                if (checkbox) checkbox.checked = true;
            }
        });
        
        if (scheduleDataObj.startTime) {
            const startInput = document.getElementById('startTime');
            if (startInput) startInput.value = scheduleDataObj.startTime;
        }
        if (scheduleDataObj.endTime) {
            const endInput = document.getElementById('endTime');
            if (endInput) endInput.value = scheduleDataObj.endTime;
        }
    }
    
    updateScheduleDisplay();
}

function clearScheduleForm() {
    selectedDays = [];
    scheduleData = { days: [], startTime: '', endTime: '' };
    
    document.querySelectorAll('.day-checkbox').forEach(label => {
        label.classList.remove('selected');
        const checkbox = label.querySelector('input');
        if (checkbox) checkbox.checked = false;
    });
    
    const startInput = document.getElementById('startTime');
    const endInput = document.getElementById('endTime');
    if (startInput) startInput.value = '';
    if (endInput) endInput.value = '';
    
    updateScheduleDisplay();
}
// Edit Class Functions
function editClass(id) {
    const classToEdit = classes.find(c => c.id === id);
    if (!classToEdit) return;
    
    // Fill the form with existing data
    document.getElementById('className').value = classToEdit.name;
    document.getElementById('classCode').value = classToEdit.code || '';
    document.getElementById('classInstructor').value = classToEdit.instructor || '';
    document.getElementById('classCredits').value = classToEdit.credits;
    document.getElementById('classSemester').value = classToEdit.semester || '';
    
    // Handle schedule data
    if (classToEdit.scheduleData) {
        setScheduleFromData(classToEdit.scheduleData);
    } else {
        clearScheduleForm();
    }
    
    // Change the add button to update mode
    const addButton = document.querySelector('#classes .btn-primary');
    if (addButton) {
        addButton.textContent = 'Update Class';
        addButton.onclick = () => updateClass(id);
        
        // Add a cancel button
        if (!document.getElementById('cancelEditBtn')) {
            const cancelBtn = document.createElement('button');
            cancelBtn.id = 'cancelEditBtn';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = cancelEdit;
            addButton.parentNode.insertBefore(cancelBtn, addButton.nextSibling);
        }
    }
    
    // Scroll to form
    document.getElementById('classes').scrollIntoView({ behavior: 'smooth' });
}

function updateClass(id) {
    const name = document.getElementById('className').value.trim();
    const code = document.getElementById('classCode').value.trim();
    const instructor = document.getElementById('classInstructor').value.trim();
    const credits = parseInt(document.getElementById('classCredits').value) || 3;
    const semester = document.getElementById('classSemester').value.trim();
    const schedule = getScheduleData();

    if (!name) {
        alert('Class name is required!');
        return;
    }

    const classIndex = classes.findIndex(c => c.id === id);
    if (classIndex !== -1) {
        classes[classIndex] = {
            ...classes[classIndex],
            name,
            code,
            instructor,
            schedule: schedule.formatted,
            scheduleData: schedule,
            credits,
            semester,
            updatedAt: new Date().toISOString()
        };
        
        saveData();
        updateClassDropdown();
        renderClasses();
        updateDashboard();
        cancelEdit();
    }
}

function cancelEdit() {
    clearClassForm();
    
    // Reset the button back to "Add Class"
    const addButton = document.querySelector('#classes .btn-primary');
    addButton.textContent = 'Add Class';
    addButton.onclick = addClass;
    
    // Remove cancel button
    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) {
        cancelBtn.remove();
    }
}

// Assignment Management
function addAssignment() {
    const name = document.getElementById('assignmentName').value.trim();
    const classId = parseInt(document.getElementById('assignmentClass').value) || null;
    const dueDate = document.getElementById('assignmentDue').value;
    const priority = document.getElementById('assignmentPriority').value;
    const points = parseInt(document.getElementById('assignmentPoints').value) || 100;
    const type = document.getElementById('assignmentType').value;
    const description = document.getElementById('assignmentDescription').value.trim();

    if (!name || !dueDate) {
        alert('Assignment name and due date are required!');
        return;
    }

    const newAssignment = {
        id: Date.now(),
        name,
        classId,
        dueDate,
        priority,
        points,
        type,
        description,
        completed: false,
        grade: null,
        submittedAt: null,
        createdAt: new Date().toISOString(),
        reminderSet: remindersEnabled
    };

    assignments.push(newAssignment);
    saveData();
    renderAssignments();
    updateDashboard();
    clearAssignmentForm();
    
    if (remindersEnabled) {
        scheduleReminder(newAssignment);
    }
}

function clearAssignmentForm() {
    ['assignmentName', 'assignmentClass', 'assignmentDue', 'assignmentPriority', 
     'assignmentPoints', 'assignmentType', 'assignmentDescription']
        .forEach(id => document.getElementById(id).value = '');
    document.getElementById('assignmentPriority').value = 'medium';
    document.getElementById('assignmentType').value = 'homework';
}

function renderAssignments() {
    const container = document.getElementById('assignmentsList');
    const searchTerm = document.getElementById('assignmentSearch')?.value.toLowerCase() || '';
    
    let filteredAssignments = assignments.filter(assignment => {
        const className = getClassName(assignment.classId).toLowerCase();
        return assignment.name.toLowerCase().includes(searchTerm) ||
               className.includes(searchTerm) ||
               (assignment.description && assignment.description.toLowerCase().includes(searchTerm));
    });

    if (filteredAssignments.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No Assignments Found</h3><p>Try adjusting your search or add a new assignment!</p></div>';
        return;
    }

    // Sort by due date
    filteredAssignments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

    container.innerHTML = filteredAssignments.map(assignment => {
        const dueDate = new Date(assignment.dueDate);
        const now = new Date();
        const isOverdue = dueDate < now && !assignment.completed;
        const isDueSoon = (dueDate - now) <= 86400000 * 3 && !assignment.completed; // 3 days
        
        return `
            <div class="item-card ${assignment.completed ? 'status-completed' : ''} ${isDueSoon ? 'due-soon' : ''} priority-${assignment.priority}">
                <div class="item-header">
                    <div>
                        <div class="item-name">${assignment.name}</div>
                        <div style="color: #718096; font-size: 0.9rem;">${getClassName(assignment.classId)}</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        ${assignment.completed ? 
                            `<span style="color: #38a169; font-weight: 600;">‚úì Completed</span>` :
                            `<button class="btn btn-success btn-small" onclick="markCompleted(${assignment.id})">Mark Done</button>`
                        }
                        <button class="btn btn-danger btn-small" onclick="deleteAssignment(${assignment.id})">Delete</button>
                    </div>
                </div>
                <div class="item-details">
                    <div class="detail-item">
                        <span class="detail-label">Due:</span> ${formatDate(dueDate)}
                        ${isOverdue ? '<span style="color: #e53e3e; font-weight: 600;"> (OVERDUE)</span>' : ''}
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Type:</span> ${assignment.type}
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Priority:</span> ${assignment.priority}
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Points:</span> ${assignment.points}
                    </div>
                </div>
                ${assignment.description ? `
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 8px;">
                        <strong>Description:</strong> ${assignment.description}
                    </div>
                ` : ''}
                <div style="margin-top: 15px; display: flex; gap: 15px; align-items: center;">
                    <label>Grade:</label>
                    <input type="number" min="0" max="${assignment.points}" 
                           value="${assignment.grade || ''}" 
                           placeholder="${assignment.points}"
                           onchange="updateGrade(${assignment.id}, this.value)"
                           style="width: 80px; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <span>/ ${assignment.points}</span>
                    ${assignment.grade ? `<span class="grade-display grade-${getGradeClass(assignment.grade, assignment.points)}">${getLetterGrade(assignment.grade, assignment.points)}</span>` : ''}
                </div>
                ${!assignment.completed && assignment.grade === null ? `
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function markCompleted(id) {
    const assignment = assignments.find(a => a.id === id);
    if (assignment) {
        assignment.completed = true;
        assignment.submittedAt = new Date().toISOString();
        saveData();
        renderAssignments();
        updateDashboard();
    }
}

function deleteAssignment(id) {
    if (confirm('Delete this assignment?')) {
        assignments = assignments.filter(a => a.id !== id);
        saveData();
        renderAssignments();
        updateDashboard();
    }
}

function updateGrade(id, grade) {
    const assignment = assignments.find(a => a.id === id);
    if (assignment) {
        assignment.grade = grade ? parseFloat(grade) : null;
        saveData();
        renderAssignments();
        updateDashboard();
        renderGrades();
    }
}

function filterAssignments() {
    renderAssignments();
}

// Calendar Management
function renderCalendar() {
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';

    // Add day headers
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.style.cssText = 'padding: 10px; text-align: center; font-weight: 600; color: #718096;';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });

    // Add calendar days
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = date.getDate();
        
        const today = new Date();
        const hasAssignment = assignments.some(a => 
            new Date(a.dueDate).toDateString() === date.toDateString()
        );
        
        if (date.toDateString() === today.toDateString()) {
            dayElement.classList.add('today');
        }
        
        if (hasAssignment) {
            dayElement.classList.add('has-assignment');
        }
        
        if (date.getMonth() !== currentDate.getMonth()) {
            dayElement.style.opacity = '0.3';
        }
        
        dayElement.onclick = () => selectCalendarDate(date);
        calendarGrid.appendChild(dayElement);
    }

    renderCalendarAssignments();
}

function selectCalendarDate(date) {
    selectedCalendarDate = date;
    document.getElementById('selectedDate').textContent = formatDate(date);
    renderCalendarAssignments();
}

function renderCalendarAssignments() {
    const container = document.getElementById('calendarAssignments');
    const dayAssignments = assignments.filter(a => 
        new Date(a.dueDate).toDateString() === selectedCalendarDate.toDateString()
    );

    if (dayAssignments.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No assignments due</h3><p>This date is free!</p></div>';
        return;
    }

    container.innerHTML = dayAssignments.map(assignment => `
        <div class="item-card ${assignment.completed ? 'status-completed' : ''} priority-${assignment.priority}">
            <div class="item-header">
                <div>
                    <div class="item-name">${assignment.name}</div>
                    <div style="color: #718096; font-size: 0.9rem;">${getClassName(assignment.classId)}</div>
                </div>
                <div>
                    ${assignment.completed ? 
                        `<span style="color: #38a169;">‚úì Completed</span>` :
                        `<button class="btn btn-success btn-small" onclick="markCompleted(${assignment.id})">Mark Done</button>`
                    }
                </div>
            </div>
            <div class="item-details">
                <div class="detail-item">
                    <span class="detail-label">Time:</span> ${new Date(assignment.dueDate).toLocaleTimeString()}
                </div>
                <div class="detail-item">
                    <span class="detail-label">Type:</span> ${assignment.type}
                </div>
                <div class="detail-item">
                    <span class="detail-label">Points:</span> ${assignment.points}
                </div>
            </div>
        </div>
    `).join('');
}

function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    renderCalendar();
}

function goToToday() {
    currentDate = new Date();
    selectedCalendarDate = new Date();
    renderCalendar();
}

// Grades Management
function renderGrades() {
    const gradedAssignments = assignments.filter(a => a.grade !== null);
    const totalPoints = gradedAssignments.reduce((sum, a) => sum + a.points, 0);
    const earnedPoints = gradedAssignments.reduce((sum, a) => sum + a.grade, 0);
    const gpa = calculateGPA();

    document.getElementById('gpaDisplay').textContent = gpa.toFixed(2);
    document.getElementById('gradedAssignments').textContent = gradedAssignments.length;

    // Render grade breakdown by class
    const container = document.getElementById('gradesByClass') || document.querySelector('#grades .list-container');
    if (!container) return;

    const gradesByClass = {};
    classes.forEach(cls => {
        const classAssignments = assignments.filter(a => a.classId === cls.id && a.grade !== null);
        if (classAssignments.length > 0) {
            const classTotal = classAssignments.reduce((sum, a) => sum + a.points, 0);
            const classEarned = classAssignments.reduce((sum, a) => sum + a.grade, 0);
            gradesByClass[cls.name] = {
                percentage: (classEarned / classTotal * 100).toFixed(1),
                assignments: classAssignments.length,
                totalPoints: classTotal,
                earnedPoints: classEarned
            };
        }
    });

    container.innerHTML = Object.keys(gradesByClass).length === 0 ? 
        '<div class="empty-state"><h3>No Grades Yet</h3><p>Complete and grade some assignments to see your progress!</p></div>' :
        Object.entries(gradesByClass).map(([className, data]) => `
            <div class="item-card">
                <div class="item-header">
                    <div class="item-name">${className}</div>
                    <div class="grade-display grade-${getGradeClass(data.earnedPoints, data.totalPoints)}">
                        ${getLetterGrade(data.earnedPoints, data.totalPoints)}
                    </div>
                </div>
                <div class="item-details">
                    <div class="detail-item">
                        <span class="detail-label">Percentage:</span> ${data.percentage}%
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Assignments:</span> ${data.assignments} graded
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Points:</span> ${data.earnedPoints}/${data.totalPoints}
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${data.percentage}%"></div>
                </div>
            </div>
        `).join('');
}

// Dashboard Updates
function updateDashboard() {
    const total = assignments.length;
    const pending = assignments.filter(a => !a.completed).length;
    const completed = assignments.filter(a => a.completed).length;
    const gradedAssignments = assignments.filter(a => a.grade !== null);
    const avgGrade = gradedAssignments.length > 0 ? 
        (gradedAssignments.reduce((sum, a) => sum + (a.grade / a.points * 100), 0) / gradedAssignments.length).toFixed(1) + '%' : '-';
    
    const oneWeekFromNow = new Date();
    oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);
    const dueSoon = assignments.filter(a => 
        !a.completed && new Date(a.dueDate) <= oneWeekFromNow
    ).length;

    document.getElementById('totalAssignments').textContent = total;
    document.getElementById('pendingAssignments').textContent = pending;
    document.getElementById('completedAssignments').textContent = completed;
    document.getElementById('avgGrade').textContent = avgGrade;
    document.getElementById('totalClasses').textContent = classes.length;
    document.getElementById('dueSoon').textContent = dueSoon;

    // Update upcoming assignments
    const upcomingContainer = document.getElementById('upcomingAssignments');
    const upcoming = assignments
        .filter(a => !a.completed)
        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
        .slice(0, 5);

    if (upcoming.length === 0) {
        upcomingContainer.innerHTML = '<div class="empty-state"><h3>All Caught Up!</h3><p>No pending assignments. Great job! üéâ</p></div>';
    } else {
        upcomingContainer.innerHTML = upcoming.map(assignment => {
            const dueDate = new Date(assignment.dueDate);
            const isOverdue = dueDate < new Date();
            
            return `
                <div class="item-card ${isOverdue ? 'due-soon' : ''} priority-${assignment.priority}">
                    <div class="item-header">
                        <div>
                            <div class="item-name">${assignment.name}</div>
                            <div style="color: #718096; font-size: 0.9rem;">${getClassName(assignment.classId)}</div>
                        </div>
                        <button class="btn btn-success btn-small" onclick="markCompleted(${assignment.id})">Mark Done</button>
                    </div>
                    <div class="item-details">
                        <div class="detail-item">
                            <span class="detail-label">Due:</span> ${formatDate(dueDate)}
                            ${isOverdue ? '<span style="color: #e53e3e; font-weight: 600;"> (OVERDUE)</span>' : ''}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Priority:</span> ${assignment.priority}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

// Reminder System
function toggleReminders() {
    remindersEnabled = !remindersEnabled;
    const toggle = document.getElementById('reminderToggle');
    const options = document.getElementById('reminderOptions');
    
    toggle.classList.toggle('active', remindersEnabled);
    options.style.display = remindersEnabled ? 'block' : 'none';
    
    if (remindersEnabled) {
        requestNotificationPermission();
    }
}

function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}

function scheduleReminder(assignment) {
    if (!remindersEnabled || Notification.permission !== 'granted') return;
    
    const reminderDays = parseInt(document.getElementById('reminderDays').value) || 3;
    const dueDate = new Date(assignment.dueDate);
    const reminderDate = new Date(dueDate);
    reminderDate.setDate(reminderDate.getDate() - reminderDays);
    
    const now = new Date();
    if (reminderDate > now) {
        setTimeout(() => {
            new Notification(`Assignment Due Soon!`, {
                body: `${assignment.name} is due in ${reminderDays} day(s)`,
                icon: '/favicon.ico'
            });
        }, reminderDate - now);
    }
}

function checkReminders() {
    if (!remindersEnabled || Notifications.permission !== 'granted') return;
    
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    assignments.forEach(assignment => {
        if (!assignment.completed && !assignment.reminderSent) {
            const dueDate = new Date(assignment.dueDate);
            if (dueDate <= tomorrow && dueDate > now) {
                new Notification(`Assignment Due Tomorrow!`, {
                    body: `${assignment.name} is due tomorrow`,
                    icon: '/favicon.ico'
                });
                assignment.reminderSent = true;
                saveData();
            }
        }
    });
}

// Utility Functions
function updateClassDropdown() {
    const dropdown = document.getElementById('assignmentClass');
    dropdown.innerHTML = '<option value="">Select a class...</option>' +
        classes.map(cls => `<option value="${cls.id}">${cls.name}</option>`).join('');
}

function getClassName(classId) {
    const cls = classes.find(c => c.id === classId);
    return cls ? cls.name : 'No Class';
}

function formatDate(date) {
    return new Intl.DateTimeFormat('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).format(date);
}

function getLetterGrade(earned, total) {
    const percentage = (earned / total) * 100;
    if (percentage >= 97) return 'A+';
    if (percentage >= 93) return 'A';
    if (percentage >= 90) return 'A-';
    if (percentage >= 87) return 'B+';
    if (percentage >= 83) return 'B';
    if (percentage >= 80) return 'B-';
    if (percentage >= 77) return 'C+';
    if (percentage >= 73) return 'C';
    if (percentage >= 70) return 'C-';
    if (percentage >= 67) return 'D+';
    if (percentage >= 63) return 'D';
    if (percentage >= 60) return 'D-';
    return 'F';
}

function getGradeClass(earned, total) {
    const percentage = (earned / total) * 100;
    if (percentage >= 90) return 'a';
    if (percentage >= 80) return 'b';
    if (percentage >= 70) return 'c';
    if (percentage >= 60) return 'd';
    return 'f';
}

function calculateGPA() {
    const gradePoints = { 'A+': 4.0, 'A': 4.0, 'A-': 3.7, 'B+': 3.3, 'B': 3.0, 'B-': 2.7, 
                         'C+': 2.3, 'C': 2.0, 'C-': 1.7, 'D+': 1.3, 'D': 1.0, 'D-': 0.7, 'F': 0.0 };
    
    const gradedAssignments = assignments.filter(a => a.grade !== null);
    if (gradedAssignments.length === 0) return 0;
    
    const totalPoints = gradedAssignments.reduce((sum, a) => {
        const letterGrade = getLetterGrade(a.grade, a.points);
        return sum + (gradePoints[letterGrade] * a.points);
    }, 0);
    
    const totalCredits = gradedAssignments.reduce((sum, a) => sum + a.points, 0);
    return totalPoints / totalCredits;
}

function saveData() {
    localStorage.setItem('classes', JSON.stringify(classes));
    localStorage.setItem('assignments', JSON.stringify(assignments));
}

function loadData() {
    classes = JSON.parse(localStorage.getItem('classes')) || [];
    assignments = JSON.parse(localStorage.getItem('assignments')) || [];
    updateClassDropdown();
}

// Canvas Integration Functions
async function connectCanvas() {
    const url = document.getElementById('canvasUrl').value.trim();
    const token = document.getElementById('canvasToken').value.trim();

    if (!url || !token) {
        alert('Please enter both Canvas URL and Access Token');
        return;
    }

    const cleanUrl = url.replace(/\/$/, '');

    const connectBtn = document.querySelector('button[onclick="connectCanvas()"]');
    const originalText = connectBtn.textContent;
    connectBtn.textContent = 'Connecting...';
    connectBtn.disabled = true;

    try {
        // Use a CORS proxy for testing
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const testUrl = encodeURIComponent(`${cleanUrl}/api/v1/courses?per_page=1&access_token=${token}`);
        
        const response = await fetch(proxyUrl + testUrl);

        if (response.ok) {
            const data = await response.json();
            
            localStorage.setItem('canvasUrl', cleanUrl);
            localStorage.setItem('canvasToken', token);

            updateCanvasStatus(true);
            logSync('Successfully connected to Canvas');

            connectBtn.textContent = 'Connected ‚úì';
            connectBtn.style.backgroundColor = '#38a169';
            
            document.getElementById('syncBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = false;
            
        } else {
            throw new Error(`Connection failed: ${response.status}`);
        }
    } catch (error) {
        console.error('Canvas connection error:', error);
        
        // Show fallback connection option
        if (confirm('Direct connection failed due to browser security restrictions. Would you like to try manual data import instead?')) {
            showManualImportOption();
        }
        
        connectBtn.textContent = originalText;
        connectBtn.disabled = false;
        connectBtn.style.backgroundColor = '';
        
        logSync('Connection failed: CORS restriction. Try manual import.');
    }
    // After successful connection, enable the disconnect button
    if (connectionSuccessful) {
        const disconnectBtn = document.getElementById('disconnectBtn');
        if (disconnectBtn) disconnectBtn.disabled = false;
        
        const syncBtn = document.getElementById('syncBtn');
        if (syncBtn) syncBtn.disabled = false;
        
        // Update connect button to show connected state
        const connectBtn = document.querySelector('button[onclick="connectCanvas()"]');
        if (connectBtn) {
            connectBtn.disabled = true; // Disable since already connected
        }
    }
}

function showManualImportOption() {
    const canvasTab = document.getElementById('canvas');
    const manualImportHTML = `
        <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
            <h4 style="margin-bottom: 15px; color: #856404;">üì• Manual Canvas Import</h4>
            <p style="margin-bottom: 15px; color: #856404;">Due to browser security restrictions, direct Canvas API access isn't possible. Follow these steps:</p>
            <ol style="margin-bottom: 15px; color: #856404;">
                <li>Go to your Canvas dashboard</li>
                <li>Export your course data or copy assignment details</li>
                <li>Use the form below to manually add your Canvas courses and assignments</li>
            </ol>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="importFromCanvasExport()">Import Canvas Export</button>
                <button class="btn btn-secondary" onclick="hideManualImport()">Cancel</button>
            </div>
        </div>
    `;
    
    const existingImport = canvasTab.querySelector('.manual-import');
    if (!existingImport) {
        const importDiv = document.createElement('div');
        importDiv.className = 'manual-import';
        importDiv.innerHTML = manualImportHTML;
        canvasTab.appendChild(importDiv);
    }
}

function hideManualImport() {
    const importDiv = document.querySelector('.manual-import');
    if (importDiv) {
        importDiv.remove();
    }
}

function importFromCanvasExport() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.csv';
    input.onchange = handleCanvasFile;
    input.click();
}

function handleCanvasFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            if (file.name.endsWith('.json')) {
                const data = JSON.parse(e.target.result);
                processCanvasJSON(data);
            } else if (file.name.endsWith('.csv')) {
                processCanvasCSV(e.target.result);
            }
        } catch (error) {
            alert('Error reading file: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function processCanvasJSON(data) {
    // Process Canvas JSON export
    let imported = 0;
    
    if (data.courses) {
        data.courses.forEach(course => {
            if (!classes.find(c => c.name === course.name)) {
                classes.push({
                    id: Date.now() + Math.random(),
                    name: course.name,
                    code: course.course_code || '',
                    instructor: course.teachers?.[0]?.name || 'Unknown',
                    schedule: '',
                    credits: 3,
                    semester: course.term || 'Current',
                    createdAt: new Date().toISOString()
                });
                imported++;
            }
        });
    }
    
    saveData();
    updateDashboard();
    updateClassDropdown();
    renderClasses();
    
    logSync(`Manual import completed: ${imported} items imported`);
    alert(`Successfully imported ${imported} courses from Canvas export!`);
}

// Enhanced sync function that includes grade fetching
async function syncCanvasWithGrades() {
    const url = localStorage.getItem('canvasUrl');
    const token = localStorage.getItem('canvasToken');
    
    if (!url || !token) {
        alert('Please connect to Canvas first');
        return;
    }
    
    try {
        // Show loading state
        const syncBtn = document.getElementById('syncBtn');
        const originalText = syncBtn.textContent;
        syncBtn.textContent = 'Syncing with Grades...';
        syncBtn.disabled = true;
        
        logSync('Starting Canvas sync with grades...');
        
        // Use CORS proxy for all requests
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        
        // Fetch courses with proxy
        const coursesUrl = encodeURIComponent(`${url}/api/v1/courses?enrollment_state=active&per_page=100&access_token=${token}`);
        const coursesResponse = await fetch(proxyUrl + coursesUrl);
        
        if (!coursesResponse.ok) {
            throw new Error(`Failed to fetch courses: ${coursesResponse.status}`);
        }
        
        const courses = await coursesResponse.json();
        let syncedCourses = 0;
        let syncedAssignments = 0;
        let syncedGrades = 0;
        
        // Sync courses first
        for (const course of courses) {
            if (!course.name || course.workflow_state === 'completed') continue;
            
            if (!classes.find(c => c.canvasId === course.id)) {
                classes.push({
                    id: Date.now() + Math.random(),
                    name: course.name,
                    code: course.course_code || '',
                    canvasId: course.id,
                    instructor: course.teachers?.[0]?.display_name || 'Unknown',
                    schedule: '',
                    credits: 3,
                    semester: course.term?.name || 'Current',
                    createdAt: new Date().toISOString()
                });
                syncedCourses++;
            }
        }
        
        // Fetch assignments and grades for each course
        for (let i = 0; i < Math.min(courses.length, 10); i++) {
            const course = courses[i];
            
            if (!course.name || course.workflow_state === 'completed') continue;
            
            try {
                // Add delay to avoid overwhelming the proxy
                if (i > 0) await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Fetch assignments
                const assignmentsUrl = encodeURIComponent(`${url}/api/v1/courses/${course.id}/assignments?per_page=50&access_token=${token}`);
                const assignmentsResponse = await fetch(proxyUrl + assignmentsUrl);
                
                if (!assignmentsResponse.ok) {
                    console.warn(`Failed to fetch assignments for course ${course.name}: ${assignmentsResponse.status}`);
                    continue;
                }
                
                const courseAssignments = await assignmentsResponse.json();
                
                // Process each assignment
                for (const assignment of courseAssignments) {
                    if (!assignment.name) continue;
                    
                    const classObj = classes.find(c => c.canvasId === course.id);
                    let existingAssignment = assignments.find(a => a.canvasId === assignment.id);
                    
                    // Set default due date if none provided
                    let dueDate = assignment.due_at;
                    if (!dueDate) {
                        const defaultDue = new Date();
                        defaultDue.setDate(defaultDue.getDate() + 7);
                        dueDate = defaultDue.toISOString();
                    }
                    
                    if (!existingAssignment) {
                        // Create new assignment
                        existingAssignment = {
                            id: Date.now() + Math.random(),
                            name: assignment.name,
                            classId: classObj?.id,
                            dueDate: dueDate,
                            priority: 'medium',
                            points: assignment.points_possible || 100,
                            type: getAssignmentType(assignment.submission_types),
                            description: stripHtml(assignment.description || ''),
                            completed: false,
                            grade: null,
                            canvasId: assignment.id,
                            createdAt: new Date().toISOString(),
                            reminderSet: remindersEnabled
                        };
                        assignments.push(existingAssignment);
                        syncedAssignments++;
                    }
                    
                    // Fetch grade for this assignment
                    try {
                        await new Promise(resolve => setTimeout(resolve, 500)); // Rate limiting
                        
                        const submissionUrl = encodeURIComponent(`${url}/api/v1/courses/${course.id}/assignments/${assignment.id}/submissions/self?access_token=${token}`);
                        const submissionResponse = await fetch(proxyUrl + submissionUrl);
                        
                        if (submissionResponse.ok) {
                            const submission = await submissionResponse.json();
                            
                            // Update assignment with grade information
                            if (submission.score !== null && submission.score !== undefined) {
                                existingAssignment.grade = submission.score;
                                existingAssignment.completed = submission.workflow_state === 'graded' || submission.submitted_at !== null;
                                existingAssignment.submittedAt = submission.submitted_at;
                                existingAssignment.gradedAt = submission.graded_at;
                                existingAssignment.canvasGradeUpdated = new Date().toISOString();
                                syncedGrades++;
                                
                                logSync(`Updated grade for ${assignment.name}: ${submission.score}/${assignment.points_possible || 100}`);
                            } else if (submission.submitted_at) {
                                // Assignment submitted but not graded yet
                                existingAssignment.completed = true;
                                existingAssignment.submittedAt = submission.submitted_at;
                                logSync(`Assignment submitted (not graded): ${assignment.name}`);
                            }
                        }
                    } catch (gradeError) {
                        console.warn(`Could not fetch grade for ${assignment.name}:`, gradeError);
                    }
                }
                
            } catch (error) {
                console.warn(`Error syncing assignments for ${course.name}:`, error);
                logSync(`Warning: Could not sync assignments for ${course.name}`);
            }
        }
        
        saveData();
        updateDashboard();
        updateClassDropdown();
        renderClasses();
        renderAssignments();
        renderGrades();
        
        // Reset button
        syncBtn.textContent = originalText;
        syncBtn.disabled = false;
        
        logSync(`Sync completed: ${syncedCourses} new courses, ${syncedAssignments} new assignments, ${syncedGrades} grades updated`);
        
        if (syncedCourses === 0 && syncedAssignments === 0 && syncedGrades === 0) {
            logSync('No new items to sync - you\'re up to date!');
        } else {
            alert(`Sync successful! Added ${syncedCourses} courses, ${syncedAssignments} assignments, and updated ${syncedGrades} grades.`);
        }
        
    } catch (error) {
        console.error('Sync error:', error);
        
        // Reset button
        const syncBtn = document.getElementById('syncBtn');
        syncBtn.textContent = 'Sync Data';
        syncBtn.disabled = false;
        
        let errorMessage = 'Sync failed: ';
        if (error.message.includes('Failed to fetch')) {
            errorMessage += 'Network error or CORS restriction. Try the manual import option.';
            showManualImportOption();
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
        logSync(errorMessage);
    }
}

// Add this function to provide a better backup sync option
async function syncCanvasWithRetry() {
    try {
        await syncCanvasWithGrades();
    } catch (error) {
        console.error('Primary sync failed:', error);
        
        // Offer alternative sync method
        if (confirm('Standard sync failed. Would you like to try a simplified sync that only gets basic course information?')) {
            await syncCanvasBasic();
        }
    }
}

async function syncCanvasBasic() {
    const url = localStorage.getItem('canvasUrl');
    const token = localStorage.getItem('canvasToken');
    
    try {
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const coursesUrl = encodeURIComponent(`${url}/api/v1/courses?enrollment_state=active&per_page=20&access_token=${token}`);
        
        const response = await fetch(proxyUrl + coursesUrl);
        const courses = await response.json();
        
        let syncedCourses = 0;
        
        courses.forEach(course => {
            if (course.name && !classes.find(c => c.canvasId === course.id)) {
                classes.push({
                    id: Date.now() + Math.random(),
                    name: course.name,
                    code: course.course_code || '',
                    canvasId: course.id,
                    instructor: 'From Canvas',
                    schedule: '',
                    credits: 3,
                    semester: 'Current',
                    createdAt: new Date().toISOString()
                });
                syncedCourses++;
            }
        });
        
        saveData();
        updateDashboard();
        updateClassDropdown();
        renderClasses();
        
        logSync(`Basic sync completed: ${syncedCourses} courses added`);
        alert(`Basic sync successful! Added ${syncedCourses} courses. Add assignments manually or try full sync later.`);
        
    } catch (error) {
        logSync('Basic sync also failed. Please use manual import.');
        showManualImportOption();
    }
}

// Helper function to determine assignment type from Canvas submission types
function getAssignmentType(submissionTypes) {
    if (!submissionTypes || submissionTypes.length === 0) return 'homework';
    
    const type = submissionTypes[0];
    switch (type) {
        case 'online_quiz': return 'quiz';
        case 'discussion_topic': return 'discussion';
        case 'online_upload': return 'project';
        case 'online_text_entry': return 'essay';
        case 'external_tool': return 'online';
        default: return 'homework';
    }
}

// Helper function to strip HTML from Canvas descriptions
function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
}

function updateCanvasStatus(connected = null) {
    if (connected === null) {
        connected = localStorage.getItem('canvasToken') ? true : false;
    }
    
    const statusEl = document.getElementById('connectionStatus');
    if (statusEl) {
        if (connected) {
            statusEl.innerHTML = '<span style="color: #38a169;">‚úì Connected (Limited functionality due to CORS)</span>';
        } else {
            statusEl.innerHTML = '<span style="color: #718096;">Not connected - Manual import available</span>';
        }
    }
    
    // Update sync button state
    const syncBtn = document.getElementById('syncBtn');
    if (syncBtn) {
        syncBtn.disabled = !connected;
    }
}

function logSync(message) {
    const log = document.getElementById('syncLog');
    if (log) {
        const timestamp = new Date().toLocaleString();
        const logEntry = document.createElement('div');
        logEntry.style.cssText = 'padding: 10px; background: #f0f9ff; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;';
        logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
        log.insertBefore(logEntry, log.firstChild);
        
        // Keep only last 10 log entries
        while (log.children.length > 10) {
            log.removeChild(log.lastChild);
        }
    }
}


// Function to enable disconnect button after successful connection
function enableDisconnectButton() {
    const disconnectBtn = document.getElementById('disconnectBtn');
    if (disconnectBtn) {
        disconnectBtn.disabled = false;
    }
    
    const syncBtn = document.getElementById('syncBtn');
    if (syncBtn) {
        syncBtn.disabled = false;
    }
}

// Disconnect function
function disconnectCanvas() {
    if (confirm('Are you sure you want to disconnect from Canvas? This will not delete your synced data.')) {
        // Clear stored credentials
        localStorage.removeItem('canvasUrl');
        localStorage.removeItem('canvasToken');
        
        // Reset connection status
        const statusEl = document.getElementById('connectionStatus');
        if (statusEl) statusEl.textContent = 'Not Connected';
        
        // Reset button states - DISABLE sync and disconnect buttons
        const syncBtn = document.getElementById('syncBtn');
        if (syncBtn) syncBtn.disabled = true;
        
        const disconnectBtn = document.getElementById('disconnectBtn');
        if (disconnectBtn) disconnectBtn.disabled = true;
        
        // Re-enable and reset connect button
        const connectBtn = document.querySelector('button[onclick="connectCanvas()"]');
        if (connectBtn) {
            connectBtn.textContent = 'üîó Connect to Canvas';
            connectBtn.disabled = false;
            connectBtn.style.backgroundColor = '';
            connectBtn.className = 'btn btn-primary';
        }
        
        // Update any other UI elements that depend on connection status
        updateCanvasStatus();
        
        // Log the disconnection
        logSync('Disconnected from Canvas');
        
        // Optional: Clear any cached data or reset other connection-related variables
        // window.canvasConnected = false;
        // window.canvasInstance = null;
    }
}

// Enhanced notification system for Canvas assignments
function scheduleCanvasNotifications() {
    if (!remindersEnabled || Notification.permission !== 'granted') return;
    
    const canvasAssignments = assignments.filter(a => a.canvasId && !a.completed);
    const reminderDays = parseInt(document.getElementById('reminderDays')?.value) || 3;
    
    canvasAssignments.forEach(assignment => {
        const dueDate = new Date(assignment.dueDate);
        const reminderDate = new Date(dueDate);
        reminderDate.setDate(reminderDate.getDate() - reminderDays);
        
        const now = new Date();
        if (reminderDate > now && !assignment.reminderScheduled) {
            setTimeout(() => {
                new Notification(`Canvas Assignment Due Soon!`, {
                    body: `${assignment.name} from ${getClassName(assignment.classId)} is due in ${reminderDays} day(s)`,
                    icon: '/favicon.ico',
                    tag: `canvas-${assignment.id}` // Prevent duplicate notifications
                });
            }, reminderDate - now);
            
            assignment.reminderScheduled = true;
            saveData();
        }
    });
}


// ==================================================
// CANVAS GRADE FETCHING ENHANCEMENT
// ==================================================

// Enhanced sync function that includes grade fetching
async function syncCanvasWithGrades() {
    const url = localStorage.getItem('canvasUrl');
    const token = localStorage.getItem('canvasToken');
    
    if (!url || !token) {
        alert('Please connect to Canvas first');
        return;
    }
    
    try {
        // Show loading state
        const syncBtn = document.getElementById('syncBtn');
        const originalText = syncBtn.textContent;
        syncBtn.textContent = 'Syncing with Grades...';
        syncBtn.disabled = true;
        
        logSync('Starting Canvas sync with grades...');
        
        // Use CORS proxy for all requests
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        
        // Fetch courses with proxy
        const coursesUrl = encodeURIComponent(`${url}/api/v1/courses?enrollment_state=active&per_page=100&access_token=${token}`);
        const coursesResponse = await fetch(proxyUrl + coursesUrl);
        
        if (!coursesResponse.ok) {
            throw new Error(`Failed to fetch courses: ${coursesResponse.status}`);
        }
        
        const courses = await coursesResponse.json();
        let syncedCourses = 0;
        let syncedAssignments = 0;
        let syncedGrades = 0;
        
        // Sync courses first
        for (const course of courses) {
            if (!course.name || course.workflow_state === 'completed') continue;
            
            if (!classes.find(c => c.canvasId === course.id)) {
                classes.push({
                    id: Date.now() + Math.random(),
                    name: course.name,
                    code: course.course_code || '',
                    canvasId: course.id,
                    instructor: course.teachers?.[0]?.display_name || 'Unknown',
                    schedule: '',
                    credits: 3,
                    semester: course.term?.name || 'Current',
                    createdAt: new Date().toISOString()
                });
                syncedCourses++;
            }
        }
        
        // Fetch assignments and grades for each course
        for (let i = 0; i < Math.min(courses.length, 10); i++) {
            const course = courses[i];
            
            if (!course.name || course.workflow_state === 'completed') continue;
            
            try {
                // Add delay to avoid overwhelming the proxy
                if (i > 0) await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Fetch assignments
                const assignmentsUrl = encodeURIComponent(`${url}/api/v1/courses/${course.id}/assignments?per_page=50&access_token=${token}`);
                const assignmentsResponse = await fetch(proxyUrl + assignmentsUrl);
                
                if (!assignmentsResponse.ok) {
                    console.warn(`Failed to fetch assignments for course ${course.name}: ${assignmentsResponse.status}`);
                    continue;
                }
                
                const courseAssignments = await assignmentsResponse.json();
                
                // Process each assignment
                for (const assignment of courseAssignments) {
                    if (!assignment.name) continue;
                    
                    const classObj = classes.find(c => c.canvasId === course.id);
                    let existingAssignment = assignments.find(a => a.canvasId === assignment.id);
                    
                    // Set default due date if none provided
                    let dueDate = assignment.due_at;
                    if (!dueDate) {
                        const defaultDue = new Date();
                        defaultDue.setDate(defaultDue.getDate() + 7);
                        dueDate = defaultDue.toISOString();
                    }
                    
                    if (!existingAssignment) {
                        // Create new assignment
                        existingAssignment = {
                            id: Date.now() + Math.random(),
                            name: assignment.name,
                            classId: classObj?.id,
                            dueDate: dueDate,
                            priority: 'medium',
                            points: assignment.points_possible || 100,
                            type: getAssignmentType(assignment.submission_types),
                            description: stripHtml(assignment.description || ''),
                            completed: false,
                            grade: null,
                            canvasId: assignment.id,
                            createdAt: new Date().toISOString(),
                            reminderSet: remindersEnabled
                        };
                        assignments.push(existingAssignment);
                        syncedAssignments++;
                    }
                    
                    // Fetch grade for this assignment
                    try {
                        await new Promise(resolve => setTimeout(resolve, 500)); // Rate limiting
                        
                        const submissionUrl = encodeURIComponent(`${url}/api/v1/courses/${course.id}/assignments/${assignment.id}/submissions/self?access_token=${token}`);
                        const submissionResponse = await fetch(proxyUrl + submissionUrl);
                        
                        if (submissionResponse.ok) {
                            const submission = await submissionResponse.json();
                            
                            // Update assignment with grade information
                            if (submission.score !== null && submission.score !== undefined) {
                                existingAssignment.grade = submission.score;
                                existingAssignment.completed = submission.workflow_state === 'graded' || submission.submitted_at !== null;
                                existingAssignment.submittedAt = submission.submitted_at;
                                existingAssignment.gradedAt = submission.graded_at;
                                existingAssignment.canvasGradeUpdated = new Date().toISOString();
                                syncedGrades++;
                                
                                logSync(`Updated grade for ${assignment.name}: ${submission.score}/${assignment.points_possible || 100}`);
                            } else if (submission.submitted_at) {
                                // Assignment submitted but not graded yet
                                existingAssignment.completed = true;
                                existingAssignment.submittedAt = submission.submitted_at;
                                logSync(`Assignment submitted (not graded): ${assignment.name}`);
                            }
                        }
                    } catch (gradeError) {
                        console.warn(`Could not fetch grade for ${assignment.name}:`, gradeError);
                    }
                }
                
            } catch (error) {
                console.warn(`Error syncing assignments for ${course.name}:`, error);
                logSync(`Warning: Could not sync assignments for ${course.name}`);
            }
        }
        
        saveData();
        updateDashboard();
        updateClassDropdown();
        renderClasses();
        renderAssignments();
        renderGrades();
        
        // Reset button
        syncBtn.textContent = originalText;
        syncBtn.disabled = false;
        
        logSync(`Sync completed: ${syncedCourses} new courses, ${syncedAssignments} new assignments, ${syncedGrades} grades updated`);
        
        if (syncedCourses === 0 && syncedAssignments === 0 && syncedGrades === 0) {
            logSync('No new items to sync - you\'re up to date!');
        } else {
            alert(`Sync successful! Added ${syncedCourses} courses, ${syncedAssignments} assignments, and updated ${syncedGrades} grades.`);
        }
        
    } catch (error) {
        console.error('Sync error:', error);
        
        // Reset button
        const syncBtn = document.getElementById('syncBtn');
        syncBtn.textContent = 'Sync Data';
        syncBtn.disabled = false;
        
        let errorMessage = 'Sync failed: ';
        if (error.message.includes('Failed to fetch')) {
            errorMessage += 'Network error or CORS restriction. Try the manual import option.';
            showManualImportOption();
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
        logSync(errorMessage);
    }
}

// Function to sync only grades for existing assignments
async function syncGradesOnly() {
    const url = localStorage.getItem('canvasUrl');
    const token = localStorage.getItem('canvasToken');
    
    if (!url || !token) {
        alert('Please connect to Canvas first');
        return;
    }
    
    // Filter assignments that have Canvas IDs
    const canvasAssignments = assignments.filter(a => a.canvasId);
    
    if (canvasAssignments.length === 0) {
        alert('No Canvas assignments found. Please sync assignments first.');
        return;
    }
    
    try {
        logSync('Starting grade-only sync...');
        let updatedGrades = 0;
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        
        // Group assignments by course for efficiency
        const assignmentsByCourse = {};
        canvasAssignments.forEach(assignment => {
            const classObj = classes.find(c => c.id === assignment.classId);
            if (classObj && classObj.canvasId) {
                if (!assignmentsByCourse[classObj.canvasId]) {
                    assignmentsByCourse[classObj.canvasId] = [];
                }
                assignmentsByCourse[classObj.canvasId].push(assignment);
            }
        });
        
        // Fetch grades for each course
        for (const [courseId, courseAssignments] of Object.entries(assignmentsByCourse)) {
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                for (const assignment of courseAssignments) {
                    try {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const submissionUrl = encodeURIComponent(`${url}/api/v1/courses/${courseId}/assignments/${assignment.canvasId}/submissions/self?access_token=${token}`);
                        const submissionResponse = await fetch(proxyUrl + submissionUrl);
                        
                        if (submissionResponse.ok) {
                            const submission = await submissionResponse.json();
                            
                            if (submission.score !== null && submission.score !== undefined) {
                                const oldGrade = assignment.grade;
                                assignment.grade = submission.score;
                                assignment.completed = submission.workflow_state === 'graded' || submission.submitted_at !== null;
                                assignment.submittedAt = submission.submitted_at;
                                assignment.gradedAt = submission.graded_at;
                                assignment.canvasGradeUpdated = new Date().toISOString();
                                
                                if (oldGrade !== submission.score) {
                                    updatedGrades++;
                                    logSync(`Grade updated: ${assignment.name} - ${submission.score} points`);
                                }
                            }
                        }
                    } catch (error) {
                        console.warn(`Error fetching grade for ${assignment.name}:`, error);
                    }
                }
            } catch (error) {
                console.warn(`Error syncing grades for course ${courseId}:`, error);
            }
        }
        
        saveData();
        renderAssignments();
        renderGrades();
        updateDashboard();
        
        logSync(`Grade sync completed: ${updatedGrades} grades updated`);
        
        if (updatedGrades === 0) {
            alert('All grades are up to date!');
        } else {
            alert(`Grade sync successful! Updated ${updatedGrades} grades.`);
        }
        
    } catch (error) {
        console.error('Grade sync error:', error);
        logSync('Grade sync failed: ' + error.message);
        alert('Failed to sync grades: ' + error.message);
    }
}

// Enhanced assignment rendering to show Canvas grade status
function renderAssignmentsWithGradeStatus() {
    const container = document.getElementById('assignmentsList');
    const searchTerm = document.getElementById('assignmentSearch')?.value.toLowerCase() || '';
    
    let filteredAssignments = assignments.filter(assignment => {
        const className = getClassName(assignment.classId).toLowerCase();
        return assignment.name.toLowerCase().includes(searchTerm) ||
               className.includes(searchTerm) ||
               (assignment.description && assignment.description.toLowerCase().includes(searchTerm));
    });

    if (filteredAssignments.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No Assignments Found</h3><p>Try adjusting your search or add a new assignment!</p></div>';
        return;
    }

    // Sort by due date
    filteredAssignments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

    container.innerHTML = filteredAssignments.map(assignment => {
        const dueDate = new Date(assignment.dueDate);
        const now = new Date();
        const isOverdue = dueDate < now && !assignment.completed;
        const isDueSoon = (dueDate - now) <= 86400000 * 3 && !assignment.completed;
        const isCanvasAssignment = assignment.canvasId;
        const hasCanvasGrade = isCanvasAssignment && assignment.grade !== null;
        const lastGradeUpdate = assignment.canvasGradeUpdated ? new Date(assignment.canvasGradeUpdated).toLocaleDateString() : null;
        
        return `
            <div class="item-card ${assignment.completed ? 'status-completed' : ''} ${isDueSoon ? 'due-soon' : ''} priority-${assignment.priority}">
                <div class="item-header">
                    <div>
                        <div class="item-name">
                            ${assignment.name}
                            ${isCanvasAssignment ? '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">Canvas</span>' : ''}
                        </div>
                        <div style="color: #718096; font-size: 0.9rem;">${getClassName(assignment.classId)}</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        ${assignment.completed ? 
                            `<span style="color: #38a169; font-weight: 600;">‚úì Completed</span>` :
                            `<button class="btn btn-success btn-small" onclick="markCompleted(${assignment.id})">Mark Done</button>`
                        }
                        <button class="btn btn-danger btn-small" onclick="deleteAssignment(${assignment.id})">Delete</button>
                    </div>
                </div>
                <div class="item-details">
                    <div class="detail-item">
                        <span class="detail-label">Due:</span> ${formatDate(dueDate)}
                        ${isOverdue ? '<span style="color: #e53e3e; font-weight: 600;"> (OVERDUE)</span>' : ''}
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Type:</span> ${assignment.type}
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Priority:</span> ${assignment.priority}
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Points:</span> ${assignment.points}
                    </div>
                    ${hasCanvasGrade && lastGradeUpdate ? `
                        <div class="detail-item">
                            <span class="detail-label">Grade Updated:</span> ${lastGradeUpdate}
                        </div>
                    ` : ''}
                </div>
                ${assignment.description ? `
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 8px;">
                        <strong>Description:</strong> ${assignment.description}
                    </div>
                ` : ''}
                <div style="margin-top: 15px; display: flex; gap: 15px; align-items: center;">
                    <label>Grade:</label>
                    <input type="number" min="0" max="${assignment.points}" 
                           value="${assignment.grade || ''}" 
                           placeholder="${assignment.points}"
                           onchange="updateGrade(${assignment.id}, this.value)"
                           ${hasCanvasGrade ? 'style="width: 80px; padding: 5px 8px; border: 1px solid #3b82f6; border-radius: 4px; background: #eff6ff;"' : 'style="width: 80px; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;"'}>
                    <span>/ ${assignment.points}</span>
                    ${assignment.grade ? `<span class="grade-display grade-${getGradeClass(assignment.grade, assignment.points)}">${getLetterGrade(assignment.grade, assignment.points)}</span>` : ''}
                    ${hasCanvasGrade ? '<span style="color: #3b82f6; font-size: 0.8rem; margin-left: 8px;">From Canvas</span>' : ''}
                </div>
            </div>
        `;
    }).join('');
}

// Function to add grade sync buttons to the Canvas tab
function addGradeSyncButtons() {
    const canvasTab = document.getElementById('canvas');
    const existingSync = canvasTab.querySelector('.grade-sync-controls');
    
    if (!existingSync) {
        const gradeSyncHTML = `
            <div class="grade-sync-controls" style="margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                <h4 style="margin-bottom: 15px;">Grade Synchronization</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="syncCanvasWithGrades()" id="fullSyncBtn">
                        Full Sync (Assignments + Grades)
                    </button>
                    <button class="btn btn-secondary" onclick="syncGradesOnly()" id="gradeSyncBtn">
                        Sync Grades Only
                    </button>
                </div>
                <p style="color: #718096; font-size: 0.9rem;">
                    <strong>Full Sync:</strong> Updates courses, assignments, and grades.<br>
                    <strong>Grades Only:</strong> Updates grades for existing Canvas assignments.
                </p>
            </div>
        `;
        
        // Insert after the existing sync section
        const syncSection = canvasTab.querySelector('button[onclick="syncCanvas()"]')?.parentElement?.parentElement;
        if (syncSection) {
            syncSection.insertAdjacentHTML('afterend', gradeSyncHTML);
        } else {
            canvasTab.insertAdjacentHTML('beforeend', gradeSyncHTML);
        }
    }
}

// Enhanced auto-sync with grades
async function autoSyncCanvasWithGrades() {
    const lastSync = localStorage.getItem('lastCanvasGradeSync');
    const now = Date.now();
    const twoHours = 2 * 60 * 60 * 1000; // Sync grades every 2 hours
    
    if (!lastSync || (now - parseInt(lastSync)) > twoHours) {
        const url = localStorage.getItem('canvasUrl');
        const token = localStorage.getItem('canvasToken');
        
        if (url && token) {
            try {
                await syncGradesOnly();
                localStorage.setItem('lastCanvasGradeSync', now.toString());
                logSync('Auto grade sync completed');
            } catch (error) {
                console.warn('Auto grade sync failed:', error);
            }
        }
    }
}

// Initialize grade sync functionality
function initializeGradeSync() {
    // Add grade sync buttons to Canvas tab
    addGradeSyncButtons();
    
    // Override the default renderAssignments function
    window.originalRenderAssignments = window.renderAssignments;
    window.renderAssignments = renderAssignmentsWithGradeStatus;
    
    // Set up auto grade sync
    setInterval(autoSyncCanvasWithGrades, 30 * 60 * 1000); // Check every 30 minutes
}

// Call initialization when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeGradeSync);
} else {
    initializeGradeSync();
}

// Initialize Canvas integration
document.addEventListener('DOMContentLoaded', function() {
    updateCanvasStatus();
    
    // Auto-sync every hour if connected (now includes grades)
    setInterval(autoSyncCanvasWithGrades, 60 * 60 * 1000);
    
    // Schedule Canvas notifications
    if (assignments.some(a => a.canvasId)) {
        scheduleCanvasNotifications();
    }
    
    // Initialize grade sync functionality
    initializeGradeSync();
});
// Song library for Tyler, The Creator
const tylerSongLibrary = {
    focus: [

        "Garden Shed", "Glitter", "November", "MASSA", "WUSYANAME", "GONE, GONE / THANK YOU",
        "AWKWARD", "Treehome95", "FIND YOUR WINGS", "2SEATER",
        "OKAGA, CA", "BLOWN AWAY", "KEEP DA O'S", "PartyIsntOver/Campfire/Bimmer",
        "Slater", "PERFECT", "Take Your Mask Off", "Like Him", "Hey Jane",
        "Foreword", "WHERE THIS FLOWER BLOOMS", "Pothole", "See You Again",
        "Sometimes...", "Ingleside", "Answer", "Colossus", "Rusty"
    ],
    
    creative: [

        "See You Again", "EARFQUAKE", "NEW MAGIC WAND", "CORSO", "SWEET / I THOUGHT YOU WANTED TO DANCE",
        "A BOY IS A GUN*", "I THINK", "JUGGERNAUT", "SIR BAUDELAIRE", "DEATHCAMP",
        "St. Chroma", "Rah Tah Tah", "Noid", "Darling, I", "Sticky",
        "Judge Judy", "Thought I Was Dead", "Like Him", "Balloon",
        "PUFF", "RISE!", "IGOR'S THEME", "PUPPET", "GONE, GONE / THANK YOU",
        "OKAGA, CA", "Cherry Bomb", "SMOG", "2SEATER", "THE BROWN STAINS OF DARKEESE LATIFAH PART 6-12",
        "BUFFALO", "F* Young / Perfect", "Deathcamp", "Pilot"
    ],
    
    chill: [
        
        "BEST INTEREST", "Boredom", "RUNNING OUT OF TIME", "SAFARI", "I THINK", "ENJOY RIGHT NOW, TODAY",
        "F* YOUNG / PERFECT", "911 / Mr. Lonely", "Potato Salad", "PEACH FUZZ",
        "Tomorrow", "I Hope You Find Your Way Home", "HEAVEN TO ME", "BLESSED",
        "EXACTLY WHAT YOU RUN FROM YOU END UP CHASING", "DOGTOOTH", "HOT WIND BLOWS",
        "LUMBERJACK", "WILSHIRE", "Droppin' Seeds", "OKAGA, CA", "F* YOUNG / PERFECT",
        "WHERE THIS FLOWER BLOOMS", "Boredom", "November", "Glitter",
        "Window", "Ingleside", "48", "IFHY", "Jamba", "VCR"
    ],
    
    energy: [
        
        "LEMONHEAD", "JUGGERNAUT", "WHO DAT BOY", "SMUCKERS", "Tamale", "WHAT'S GOOD",
        "NEW MAGIC WAND", "Yonkers", "Rella", "I Ain't Got Time!",
        "Sticky", "Rah Tah Tah", "Thought I Was Dead", "WUSYANAME", "LUMBERJACK",
        "HOT WIND BLOWS", "CORSO", "MASSA", "JUGGERNAUT", "WHAT'S GOOD",
        "Who Dat Boy", "I Ain't Got Time!", "Domo23", "Tamale", "Trouble On My Mind",
        "Cherry Bomb", "DEATHCAMP", "SMOG", "2SEATER", "BUFFALO",
        "Tron Cat", "Yonkers", "She", "Radicals", "B.S.D.", "Window",
        "Sandwitches", "A**Milk", "Bastard", "Seven", "Odd Toddlers"
    ],
    
    introspective: [
        
        "PUPPET", "ARE WE STILL FRIENDS?", "Answer", "WILSHIRE", "48",
        "911 / Mr. Lonely", "IFHY", "Colossus", "Lone", "Her",
        "Take Your Mask Off", "Hey Jane", "I Hope You Find Your Way Home", 
        "Like Him", "Judge Judy", "Tomorrow", "Darling, I", "HEAVEN TO ME",
        "BLESSED", "EXACTLY WHAT YOU RUN FROM YOU END UP CHASING", "ARE WE STILL FRIENDS?",
        "THANK YOU", "I DON'T LOVE YOU ANYMORE", "GONE, GONE / THANK YOU",
        "PUPPET", "A BOY IS A GUN*", "IGOR'S THEME", "Boredom", "Foreword",
        "911 / Mr. Lonely", "Dropping Seeds", "Garden Shed", "Glitter",
        "FIND YOUR WINGS", "Answer", "Colossus", "Lone", "48", "IFHY",
        "Goblin", "Her", "AU79", "Golden", "Awkward", "PartyIsntOver"
    ]
};

function generatePlaylistSuggestions() {
    const mood = document.getElementById('studyMood').value;
    const subject = document.getElementById('studySubject').value;
    const suggestionsDiv = document.getElementById('playlistSuggestions');
    
    if (!mood) {
        suggestionsDiv.innerHTML = '<p style="color: #718096;">Please select a mood to generate playlist suggestions.</p>';
        return;
    }
    
    const songsForMood = tylerSongLibrary[mood];
    if (!songsForMood || songsForMood.length === 0) {
        suggestionsDiv.innerHTML = '<p style="color: #718096;">No songs found for this mood.</p>';
        return;
    }

    // Shuffle the array and pick the first 5-7 songs
    const shuffled = songsForMood.sort(() => 0.5 - Math.random());
    const selectedSongs = shuffled.slice(0, Math.floor(Math.random() * 3) + 5); // Randomly pick 5, 6, or 7 songs

    const suggestionTemplates = {
        focus: { title: "Deep Focus Flow", description: "Calmer Tyler tracks and instrumentals perfect for deep concentration." },
        creative: { title: "Creative Expression Mode", description: "Colorful, experimental tracks that spark imagination." },
        chill: { title: "Laid-Back Study Sessions", description: "Mellow, dreamy tracks for relaxed learning." },
        energy: { title: "High-Energy Hustle", description: "Motivational tracks to power through challenging sessions." },
        introspective: { title: "Thoughtful Reflection", description: "Deeper, contemplative tracks for critical thinking." }
    };
    
    const suggestion = suggestionTemplates[mood];
    const songsList = selectedSongs.map(song => `<div class="song-item">üéµ ${song}</div>`).join('');
        
        suggestionsDiv.innerHTML = `
            <div class="playlist-suggestion">
                <div class="playlist-title">${suggestion.title}</div>
                <div class="playlist-description">${suggestion.description}</div>
            <div style="margin-top: 15px;">
                <div style="font-weight: 600; margin-bottom: 8px;">Your Randomly Generated Playlist:</div>
                    ${songsList}
                </div>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 0.9rem; color: #1e40af;">
            üí° Tip: Click the "Generate" button again for a new random selection!
            </div>
        `;
    }


// Tyler tab visibility logic
let canvasClickCount = 0;
let tylerTabVisible = false;

const originalShowTab = window.showTab;
window.showTab = function(tabName) {
   if (tabName === 'canvas') {
       canvasClickCount++;
       if (canvasClickCount >= 3 && !tylerTabVisible) {
           showTylerTab();
       }
   } else {
       // Reset counter if any other tab is clicked
       canvasClickCount = 0;
   }
   
   // Call original showTab function
   if (originalShowTab) {
       originalShowTab(tabName);
   } else {
       // Fallback implementation if showTab doesn't exist yet
       document.querySelectorAll('.tab-content').forEach(content => {
           content.classList.remove('active');
       });
       document.querySelectorAll('.tab-button').forEach(button => {
           button.classList.remove('active');
       });
       
       const targetTab = document.getElementById(tabName);
       const targetButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
       
       if (targetTab) targetTab.classList.add('active');
       if (targetButton) targetButton.classList.add('active');
   }
};

function showTylerTab() {
   tylerTabVisible = true;
   const tylerButton = document.querySelector('[onclick="showTab(\'tyler\')"]');
   
   if (tylerButton) {
       // Create unlock animation overlay
       const unlockOverlay = document.createElement('div');
       unlockOverlay.style.cssText = `
           position: fixed;
           top: 0;
           left: 0;
           width: 100vw;
           height: 100vh;
           background: rgba(0, 0, 0, 0.8);
           display: flex;
           justify-content: center;
           align-items: center;
           z-index: 10000;
           animation: fadeIn 0.3s ease;
       `;
       
       const unlockContent = document.createElement('div');
       unlockContent.style.cssText = `
           background: linear-gradient(135deg, #ffffff, #999999);
           padding: 40px;
           border-radius: 20px;
           text-align: center;
           box-shadow: 0 20px 50px rgba(255, 215, 0, 0.3);
           transform: scale(0);
           animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
       `;
       
       unlockContent.innerHTML = `
           <div style="font-size: 4rem; margin-bottom: 20px; animation: spin 1s ease-in-out;">üêù</div>
           <h2 style="color: #333; margin-bottom: 15px; font-size: 2rem;">Secret Unlocked!</h2>
           <p style="color: #666; font-size: 1.2rem; margin-bottom: 20px;">Tyler, The Creator tab is now available</p>
           <div style="font-size: 1.5rem; color: #333;">‚ú® IGOR OUT NOW! ‚ú®</div>
       `;
       
       unlockOverlay.appendChild(unlockContent);
       document.body.appendChild(unlockOverlay);
       
       // Add keyframe animations
       const style = document.createElement('style');
       style.textContent = `
           @keyframes fadeIn {
               from { opacity: 0; }
               to { opacity: 1; }
           }
           
           @keyframes bounceIn {
               0% { transform: scale(0) rotate(-360deg); }
               60% { transform: scale(1.2) rotate(0deg); }
               100% { transform: scale(1) rotate(0deg); }
           }
           
           @keyframes spin {
               0% { transform: rotate(0deg); }
               100% { transform: rotate(360deg); }
           }
           
           @keyframes tylerReveal {
               0% { 
                   opacity: 0; 
                   transform: translateX(-100px) scale(0.8); 
                   filter: blur(5px);
               }
               100% { 
                   opacity: 1; 
                   transform: translateX(0) scale(1); 
                   filter: blur(0);
               }
           }
       `;
       document.head.appendChild(style);
       
       // Remove overlay after 3 seconds and show Tyler tab
       setTimeout(() => {
           unlockOverlay.style.animation = 'fadeIn 0.3s ease reverse';
           setTimeout(() => {
               document.body.removeChild(unlockOverlay);
               
               // Show Tyler tab with special animation
               tylerButton.style.display = 'block';
               tylerButton.style.animation = 'tylerReveal 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards';
               tylerButton.style.color = '#333';
               tylerButton.style.boxShadow = '0 5px 15px rgba(255, 215, 0, 0.4)';
               
               // Add sparkle effect
               for (let i = 0; i < 5; i++) {
                   setTimeout(() => {
                       createSparkle(tylerButton);
                   }, i * 200);
               }
           }, 300);
       }, 3000);
   }
}

function createSparkle(element) {
   const sparkle = document.createElement('div');
   sparkle.innerHTML = '‚ú®';
   sparkle.style.cssText = `
       position: absolute;
       pointer-events: none;
       font-size: 1.5rem;
       z-index: 1000;
       animation: sparkleFloat 2s ease-out forwards;
   `;
   
   const rect = element.getBoundingClientRect();
   sparkle.style.left = (rect.left + Math.random() * rect.width) + 'px';
   sparkle.style.top = (rect.top + Math.random() * rect.height) + 'px';
   
   const sparkleStyle = document.createElement('style');
   sparkleStyle.textContent = `
       @keyframes sparkleFloat {
           0% { 
               opacity: 1; 
               transform: translateY(0) scale(1); 
           }
           100% { 
               opacity: 0; 
               transform: translateY(-50px) scale(0.5); 
           }
       }
   `;
   document.head.appendChild(sparkleStyle);
   
   document.body.appendChild(sparkle);
   
   setTimeout(() => {
       if (sparkle.parentNode) {
           sparkle.parentNode.removeChild(sparkle);
       }
   }, 2000);
}

// Hide Tyler tab initially
document.addEventListener('DOMContentLoaded', function() {
   const tylerButton = document.querySelector('[onclick="showTab(\'tyler\')"]');
   if (tylerButton) tylerButton.style.display = 'none';
   const style = document.createElement('style');
   style.textContent = `@keyframes tada{from{transform:scale3d(1,1,1)}10%,20%{transform:scale3d(.9,.9,.9) rotate3d(0,0,1,-3deg)}30%,50%,70%,90%{transform:scale3d(1.1,1.1,1.1) rotate3d(0,0,1,3deg)}40%,60%,80%{transform:scale3d(1.1,1.1,1.1) rotate3d(0,0,1,-3deg)}to{transform:scale3d(1,1,1)}}`;
   document.head.appendChild(style);
});

</script>